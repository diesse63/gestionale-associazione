<!DOCTYPE html>
<html lang="it" data-theme="emerald">
<head>
    <meta charset="UTF-8"><title>Login - Gestionale</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CONTROLLO PREVENTIVO: Se sei giÃ  loggato, vai via da qui! -->
    <script>
        if (sessionStorage.getItem('userRole')) {
            window.location.href = "/";
        }
    </script>
</head>
<body class="bg-base-200 min-h-screen flex items-center justify-center">
    <div class="card w-96 bg-white shadow-2xl">
        <div class="card-body">
            <h2 class="card-title text-3xl font-black italic uppercase text-primary">Accesso</h2>
            <div class="form-control">
                <label class="label"><span class="label-text">User ID (Email)</span></label>
                <input type="text" id="user" class="input input-bordered" placeholder="nome@ente.it">
            </div>
            <div class="form-control mt-4">
                <label class="label"><span class="label-text">Password</span></label>
                <input type="password" id="pass" class="input input-bordered" placeholder="******">
            </div>
            <button onclick="doLogin()" class="btn btn-primary mt-6 text-white font-bold">ENTRA</button>
            <p id="error-msg" class="text-red-500 text-center mt-2 hidden">Credenziali errate</p>
        </div>
    </div>

    <!-- Script Login -->
    <script>
        async function doLogin() {
            const email = document.getElementById('user').value;
            const password = document.getElementById('pass').value;
            const errorMsg = document.getElementById('error-msg');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if(data.success) {
                    // Login OK: Salva sessione client e vai alla Home
                    sessionStorage.setItem('userRole', 'admin'); 
                    sessionStorage.setItem('userName', data.nome);
                    window.location.href = '/'; 
                } else {
                    errorMsg.classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                alert("Errore di connessione al server");
            }
        }
        
        // Permette di premere Invio per login
        document.getElementById("pass").addEventListener("keypress", function(event) {
            if (event.key === "Enter") doLogin();
        });
    </script>
</body>
</html>