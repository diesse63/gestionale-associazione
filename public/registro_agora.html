<!DOCTYPE html>
<html lang="it" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <title>Archivio Agorà - Gestionale Pro</title>
    <!-- Importazione Stili e Librerie -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-base-200 min-h-screen relative">
    
    <!-- Tasto Indietro -->
    <a href="index.html" class="btn btn-sm btn-neutral absolute top-4 left-4 shadow-md z-10">
        ⬅ Indietro
    </a>

    <!-- Container Principale -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-12">
        
        <!-- Intestazione Pagina -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10">
            <div>
                <h1 class="text-5xl font-black text-gray-900 uppercase italic text-blue-600">Archivio Agorà</h1>
                <p class="text-gray-500 font-bold uppercase text-xs mt-2 ml-1">Gestione Eventi, Verbali e Documenti</p>
            </div>
            <div class="flex gap-4">
                <!-- Barra di Ricerca -->
                <input type="text" id="searchInput" placeholder="Cerca evento..." class="input input-bordered shadow-xl w-full md:w-80" onkeyup="filterTable()" />
                <!-- Bottone Nuovo -->
                <label for="modal-agora" onclick="preparaNuovo()" class="btn bg-blue-600 border-none text-white shadow-lg rounded-xl uppercase">Nuovo Evento</label>
            </div>
        </div>

        <!-- Card Tabella -->
        <div class="card bg-white shadow-2xl rounded-3xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <!-- Intestazione Colonne -->
                    <thead class="bg-gray-900 text-white uppercase text-xs">
                        <tr>
                            <th class="py-6 px-8 w-32 align-top">Data</th>
                            <th class="align-top">Evento</th>
                            <th class="align-top">Anteprima ODG</th>
                            <th class="text-center align-top">Verbale</th>
                            <th class="text-center align-top">Doc</th>
                            <th class="text-right px-8 align-top">Azione</th>
                        </tr>
                    </thead>
                    <!-- Corpo Tabella (popolato via JS) -->
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modale (Popup) per Inserimento/Modifica -->
    <input type="checkbox" id="modal-agora" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box rounded-3xl p-8 max-w-5xl"> 
            <h3 id="modal-title" class="font-black text-2xl uppercase mb-6 border-b-4 border-blue-600 pb-2 text-blue-600 italic">Dettaglio Evento</h3>
            
            <form id="agoraForm" class="space-y-4">
                <input type="hidden" id="ago-id">
                
                <!-- Riga 1: Data e Titolo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label text-xs font-bold text-gray-400 uppercase">Data Evento</label>
                        <input type="date" id="ago-data" required class="input input-bordered font-bold text-gray-700">
                    </div>
                    <div class="form-control md:col-span-2">
                        <label class="label text-xs font-bold text-gray-400 uppercase">Titolo Evento</label>
                        <input type="text" id="ago-evento" required class="input input-bordered font-bold uppercase" placeholder="Es. ASSEMBLEA GENERALE">
                    </div>
                </div>

                <!-- Riga 2: ODG -->
                <div class="form-control">
                    <label class="label text-xs font-bold text-gray-400 uppercase">Ordine del Giorno</label>
                    <textarea id="ago-odg" class="textarea textarea-bordered h-24 font-medium text-sm" placeholder="Inserisci i punti..."></textarea>
                </div>

                <!-- SEZIONE REGISTRO PRESENZE -->
                <div class="bg-base-100 p-5 rounded-xl border border-gray-200 mt-4 shadow-sm">
                    <h4 class="font-black text-sm uppercase text-gray-500 mb-3 flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4"></i> Registro Presenze
                    </h4>
                    
                    <!-- Area Aggiunta Partecipante (FILTRO + SELECT) -->
                    <div id="add-partecipante-area" class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-4 p-3 bg-blue-50 rounded-lg hidden">
                        
                        <!-- 1. CAMPO FILTRO (Nuovo - A Sinistra) -->
                        <div class="md:col-span-3">
                            <input type="text" id="filter-people-input" placeholder="Filtra Associazione/Nome..." 
                                   class="input input-bordered input-sm w-full text-xs uppercase" 
                                   onkeyup="loadUniqueOptions(this.value)">
                        </div>

                        <!-- 2. SELECT (Ridimensionato) -->
                        <div class="md:col-span-7">
                            <select id="new-unique-select" class="select select-bordered select-sm w-full uppercase text-xs">
                                <option value="" disabled selected>Seleziona Partecipante...</option>
                                <!-- Popolato via JS -->
                            </select>
                        </div>

                        <!-- 3. BOTTONE -->
                        <div class="md:col-span-2 text-right">
                            <button type="button" onclick="handleAddPresente()" class="btn btn-sm btn-primary w-full text-white font-bold"><i data-lucide="plus"></i> Agg.</button>
                        </div>
                    </div>

                    <!-- Tabella Presenze -->
                    <div class="overflow-x-auto w-full">
                        <table class="table table-xs w-full bg-white">
                            <thead class="bg-gray-100 text-gray-600 uppercase">
                                <tr>
                                    <th>Associazione</th>
                                    <th class="w-8"></th> <!-- Colonna Icona T -->
                                    <th class="w-8"></th> <!-- Colonna Icona D -->
                                    <th>Rappresentante</th>
                                    <th class="w-10 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="presentiTableBody">
                                <!-- Popolato via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SEZIONE FILE (VERBALE E DOCUMENTI) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    
                    <!-- Verbale -->
                    <div class="form-control bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300">
                        <label class="label text-xs font-bold text-gray-400 uppercase">Verbale (PDF)</label>
                        
                        <!-- Visualizzazione File Esistente -->
                        <div id="view-verbale" class="hidden flex items-center justify-between bg-white p-2 rounded border mb-2">
                            <span id="name-verbale" class="text-xs font-bold truncate max-w-[150px]"></span>
                            <div class="flex gap-1">
                                <a id="link-verbale" href="#" target="_blank" class="btn btn-xs btn-info text-white"><i data-lucide="eye" class="w-3"></i></a>
                                <button type="button" onclick="rimuoviFile('verbale')" class="btn btn-xs btn-error text-white"><i data-lucide="x" class="w-3"></i></button>
                            </div>
                        </div>

                        <!-- Input Upload -->
                        <input type="file" id="ago-verbale-file" accept=".pdf" class="file-input file-input-bordered file-input-sm w-full" />
                        <input type="hidden" id="delete-verbale-flag" value="false">
                    </div>

                    <!-- Documenti -->
                    <div class="form-control bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300">
                        <label class="label text-xs font-bold text-gray-400 uppercase">Documenti (PDF)</label>
                        
                        <!-- Visualizzazione File Esistente -->
                        <div id="view-docs" class="hidden flex items-center justify-between bg-white p-2 rounded border mb-2">
                            <span id="name-docs" class="text-xs font-bold truncate max-w-[150px]"></span>
                            <div class="flex gap-1">
                                <a id="link-docs" href="#" target="_blank" class="btn btn-xs btn-info text-white"><i data-lucide="eye" class="w-3"></i></a>
                                <button type="button" onclick="rimuoviFile('docs')" class="btn btn-xs btn-error text-white"><i data-lucide="x" class="w-3"></i></button>
                            </div>
                        </div>

                        <!-- Input Upload -->
                        <input type="file" id="ago-docs-file" accept=".pdf" class="file-input file-input-bordered file-input-sm w-full" />
                        <input type="hidden" id="delete-docs-flag" value="false">
                    </div>
                </div>

                <!-- Bottoni Azione -->
                <div class="modal-action flex justify-between mt-8">
                    <button type="button" id="btn-delete" onclick="handleDelete()" class="btn btn-error btn-outline hidden uppercase font-bold text-xs">Elimina Evento</button>
                    <div class="flex gap-2">
                        <label for="modal-agora" class="btn btn-ghost uppercase text-xs font-bold font-black">Annulla</label>
                        <button type="button" onclick="handleSave()" class="btn bg-blue-600 border-none text-white font-bold uppercase px-8 text-xs shadow-lg">Salva</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Logica JavaScript -->
    <script src="assets/js/config.js"></script>
    <script>
        let localDataCache = [];
        let allPeopleCache = [];

        async function init() {
            try {
                // Carica Tutte le persone per il filtro unico
                const resPeople = await fetch('/api/persone/tutti');
                allPeopleCache = await resPeople.json();
                loadUniqueOptions(); // Carica senza filtro iniziale

                // Carica Eventi
                const res = await fetch('/api/agora'); 
                const data = await res.json();
                
                localDataCache = (data || []).sort((a, b) => new Date(b.Data) - new Date(a.Data));
                renderTable(localDataCache);
            } catch(e){ 
                console.error("Errore caricamento:", e);
                renderTable([]);
            }
        }

        // Popola il Select Unico con supporto FILTRO
        function loadUniqueOptions(filterText = "") {
            const sel = document.getElementById('new-unique-select');
            const currentVal = sel.value; // Tenta di mantenere la selezione se possibile
            
            sel.innerHTML = '<option value="" disabled selected>SELEZIONA PARTECIPANTE (ASSOCIAZIONE - NOME)</option>';
            
            const search = filterText.toLowerCase();

            allPeopleCache.forEach(p => {
                // Filtra su SOGGETTO (Associazione), NOME (Rappresentante) o TIPO
                const textToSearch = `${p.SOGGETTO} ${p.Nome} ${p.Tipo}`.toLowerCase();
                
                if (textToSearch.includes(search)) {
                    const opt = document.createElement('option');
                    // Value contiene ID Associazione e Nome separati da ::
                    opt.value = `${p.ID_Associazione}::${p.Nome}`;
                    // Text: "ASSOCIAZIONE - Nome (Tipo)"
                    opt.text = `${p.SOGGETTO.toUpperCase()} - ${p.Nome} (${p.Tipo})`;
                    sel.appendChild(opt);
                }
            });

            // Se il valore precedentemente selezionato esiste ancora nelle opzioni filtrate, riselezionalo
            if (currentVal && Array.from(sel.options).some(o => o.value === currentVal)) {
                sel.value = currentVal;
            } else {
                sel.selectedIndex = 0;
            }
        }

        // --- Rendering Tabella ---
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-400 italic">Nessun evento trovato.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(row => {
                let dataFmt = row.Data;
                try {
                    const d = new Date(row.Data);
                    if(!isNaN(d)) dataFmt = d.toLocaleDateString('it-IT');
                } catch(e){}

                const fullODG = row.ODG || '-';
                const hasVerbale = row.Verbale && row.Verbale.length > 5;
                const hasDocs = row.Documenti && row.Documenti.length > 5;

                return `
                <tr class="hover:bg-blue-50 cursor-pointer group transition-colors border-b border-gray-100" onclick="openEdit(${row.ID})">
                    <td class="font-bold text-gray-600 py-6 px-8 font-mono text-sm align-top">${dataFmt}</td>
                    <td class="font-black uppercase text-gray-800 text-sm tracking-wide align-top">${row.Evento || 'Senza Titolo'}</td>
                    <td class="text-gray-600 text-xs align-top whitespace-pre-wrap leading-relaxed max-w-md">${fullODG}</td>
                    
                    <td class="text-center align-top pt-6">
                        ${hasVerbale 
                            ? `<span class="badge badge-success badge-sm gap-1 text-white text-[10px] font-bold uppercase cursor-pointer hover:scale-110 transition-transform" 
                                onclick="event.stopPropagation(); window.open('${row.Verbale}', '_blank')">
                                <i data-lucide="check" class="w-3"></i> SI
                               </span>` 
                            : `<span class="text-gray-300">-</span>`}
                    </td>
                    
                    <td class="text-center align-top pt-6">
                        ${hasDocs 
                            ? `<span class="badge badge-info badge-sm gap-1 text-white text-[10px] font-bold uppercase cursor-pointer hover:scale-110 transition-transform" 
                                onclick="event.stopPropagation(); window.open('${row.Documenti}', '_blank')">
                                <i data-lucide="folder" class="w-3"></i> SI
                               </span>` 
                            : `<span class="text-gray-300">-</span>`}
                    </td>

                    <td class="text-right px-8 align-top pt-6">
                        <button class="btn btn-xs btn-ghost text-blue-600 font-bold uppercase group-hover:bg-white">
                            Modifica <i data-lucide="edit-3" class="w-3 h-3 ml-1"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            
            if(window.lucide) lucide.createIcons();
        }

        function preparaNuovo() { 
            document.getElementById('agoraForm').reset(); 
            document.getElementById('ago-id').value = ''; 
            document.getElementById('ago-data').valueAsDate = new Date();
            
            document.getElementById('btn-delete').classList.add('hidden');
            document.getElementById('add-partecipante-area').classList.add('hidden'); 
            document.getElementById('presentiTableBody').innerHTML = `<tr><td colspan="5" class="text-center italic text-xs py-4">Salva l'evento prima di aggiungere i presenti.</td></tr>`;
            
            resetFileUI('verbale');
            resetFileUI('docs');
            
            // Reset Filtro
            document.getElementById('filter-people-input').value = "";
            loadUniqueOptions();
        }

        async function openEdit(id) {
            const s = localDataCache.find(x => x.ID == id);
            if(!s) return;
            
            document.getElementById('ago-id').value = s.ID;
            document.getElementById('ago-data').value = s.Data; 
            document.getElementById('ago-evento').value = s.Evento;
            document.getElementById('ago-odg').value = s.ODG || ''; 
            
            setupFileUI('verbale', s.Verbale);
            setupFileUI('docs', s.Documenti);

            document.getElementById('add-partecipante-area').classList.remove('hidden');
            loadPresenti(id);
            
            // Reset Select Unica e Filtro
            document.getElementById('filter-people-input').value = "";
            loadUniqueOptions();
            document.getElementById('new-unique-select').value = "";

            document.getElementById('btn-delete').classList.remove('hidden');
            document.getElementById('modal-agora').checked = true;
        }

        function setupFileUI(type, path) {
            const viewDiv = document.getElementById(type === 'verbale' ? 'view-verbale' : 'view-docs');
            const fileInput = document.getElementById(type === 'verbale' ? 'ago-verbale-file' : 'ago-docs-file');
            const nameSpan = document.getElementById(type === 'verbale' ? 'name-verbale' : 'name-docs');
            const linkBtn = document.getElementById(type === 'verbale' ? 'link-verbale' : 'link-docs');
            const deleteFlag = document.getElementById(type === 'verbale' ? 'delete-verbale-flag' : 'delete-docs-flag');

            deleteFlag.value = "false"; 

            if (path && path.length > 5) {
                viewDiv.classList.remove('hidden');
                fileInput.classList.add('hidden');
                const nomeFile = path.split('/').pop();
                nameSpan.innerText = nomeFile;
                linkBtn.href = path;
            } else {
                viewDiv.classList.add('hidden');
                fileInput.classList.remove('hidden');
                fileInput.value = ""; 
            }
        }

        function rimuoviFile(type) {
            if(!confirm("Il file verrà eliminato dal server al salvataggio. Procedere?")) return;
            
            document.getElementById(type === 'verbale' ? 'view-verbale' : 'view-docs').classList.add('hidden');
            document.getElementById(type === 'verbale' ? 'ago-verbale-file' : 'ago-docs-file').classList.remove('hidden');
            document.getElementById(type === 'verbale' ? 'delete-verbale-flag' : 'delete-docs-flag').value = "true";
        }
        
        function resetFileUI(type) {
             document.getElementById(type === 'verbale' ? 'view-verbale' : 'view-docs').classList.add('hidden');
             document.getElementById(type === 'verbale' ? 'ago-verbale-file' : 'ago-docs-file').classList.remove('hidden');
             document.getElementById(type === 'verbale' ? 'ago-verbale-file' : 'ago-docs-file').value = "";
             document.getElementById(type === 'verbale' ? 'delete-verbale-flag' : 'delete-docs-flag').value = "false";
        }

        async function loadPresenti(idRiunione) {
            const tbody = document.getElementById('presentiTableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-xs italic">Caricamento...</td></tr>`;

            try {
                const res = await fetch(`/api/agora/${idRiunione}/presenti`);
                const data = await res.json(); 

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-xs text-gray-400">Nessun partecipante registrato.</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(row => {
                    const isTavolo = row.TAVOLO == 1;
                    const isDirettivo = row.DIRETTIVO_DELEGAZIONE == 1;
                    
                    return `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="font-bold text-gray-700 uppercase text-[11px]" title="${row.SOGGETTO || ''}">
                            ${row.SOGGETTO || 'N/D'}
                        </td>
                        <td class="text-center">
                            ${isTavolo ? '<span class="badge badge-primary badge-xs text-white font-bold h-5 w-5 p-0">T</span>' : ''}
                        </td>
                        <td class="text-center">
                            ${isDirettivo ? '<span class="badge badge-secondary badge-xs text-white font-bold h-5 w-5 p-0">D</span>' : ''}
                        </td>
                        <td class="text-gray-600 text-xs italic">
                            ${row.Rappresentante || '-'}
                        </td>
                        <td class="text-right">
                             <button type="button" onclick="handleDeletePresente(${row.IDRiga})" class="btn btn-ghost btn-xs text-red-500 hover:bg-red-50"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </td>
                    </tr>
                    `;
                }).join('');
                if(window.lucide) lucide.createIcons();

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-xs text-red-400">Errore caricamento.</td></tr>`;
            }
        }

        // Funzione Aggiunta (Usa Select Unico)
        async function handleAddPresente() {
            const idRiunione = document.getElementById('ago-id').value;
            const val = document.getElementById('new-unique-select').value; // Formato: "IDAss::Nome"

            if(!idRiunione) return alert("Salva prima l'evento.");
            if(!val) return alert("Seleziona un partecipante dalla lista.");

            const [idAss, nome] = val.split('::');

            try {
                const res = await fetch('/api/agora/presenti', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ IDRiunioni: idRiunione, IDAssociazione: idAss, Rappresentante: nome })
                });
                if(res.ok) {
                    loadPresenti(idRiunione);
                    document.getElementById('new-unique-select').value = "";
                } else {
                    alert("Errore inserimento.");
                }
            } catch(e) { console.error(e); }
        }

        async function handleDeletePresente(idRiga) {
            if(!confirm("Rimuovere questo partecipante?")) return;
            try {
                const res = await fetch(`/api/agora/presenti/${idRiga}`, { method: 'DELETE' });
                if(res.ok) loadPresenti(document.getElementById('ago-id').value);
            } catch(e) { console.error(e); }
        }

        async function handleSave() {
            const id = document.getElementById('ago-id').value;
            
            const formData = new FormData();
            
            // --- CRUCIALE: APPENDERE 'Data' PRIMA DEI FILE PER PERMETTERE LA RINOMINA ---
            const dataVal = document.getElementById('ago-data').value;
            const eventoVal = document.getElementById('ago-evento').value.toUpperCase();
            
            if(!dataVal || !eventoVal) return alert("Compilare Data ed Evento.");
            
            formData.append('Data', dataVal);
            formData.append('Evento', eventoVal);
            formData.append('ODG', document.getElementById('ago-odg').value);
            
            const fileVerbale = document.getElementById('ago-verbale-file').files[0];
            const fileDocs = document.getElementById('ago-docs-file').files[0];
            
            // Ora appendiamo i file (il server avrà già letto 'Data')
            if(fileVerbale) formData.append('verbale', fileVerbale);
            if(fileDocs) formData.append('documenti', fileDocs);

            formData.append('deleteVerbale', document.getElementById('delete-verbale-flag').value);
            formData.append('deleteDocumenti', document.getElementById('delete-docs-flag').value);

            if(!confirm("Salvare i dati?")) return;

            const url = id ? `/api/agora/${id}` : '/api/agora';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { 
                    method: method, 
                    body: formData 
                });
                
                if(res.ok) { 
                    const result = await res.json();
                    if(!id && result.id) {
                         alert("Evento creato. Ora puoi inserire i partecipanti.");
                         document.getElementById('modal-agora').checked = false;
                         init();
                         setTimeout(() => openEdit(result.id), 500);
                    } else {
                        document.getElementById('modal-agora').checked = false; 
                        init(); 
                    }
                } else {
                    alert("Errore salvataggio.");
                }
            } catch(e) { console.error(e); }
        }

        async function handleDelete() {
            if(!confirm("Eliminare definitivamente questo evento e tutti i file associati?")) return;
            try {
                const res = await fetch(`/api/agora/${document.getElementById('ago-id').value}`, { method: 'DELETE' });
                if(res.ok) { document.getElementById('modal-agora').checked = false; init(); }
            } catch(e) { console.error(e); }
        }

        function filterTable() {
            const q = document.getElementById("searchInput").value.toUpperCase();
            const rows = document.getElementById("tableBody").getElementsByTagName("tr");
            for (let r of rows) {
                if(r.getElementsByTagName('td').length > 1) {
                    r.style.display = r.innerText.toUpperCase().includes(q) ? "" : "none";
                }
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>