<!DOCTYPE html>
<html lang="it" data-theme="emerald">
<head>
    <meta charset="UTF-8"><title>Altri Soggetti - Gestionale Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-base-200 min-h-screen relative">
    
    <!-- Tasto Indietro -->
    <a href="servizi.html" class="btn btn-sm btn-neutral absolute top-4 left-4 shadow-md z-10">
        ⬅ Indietro
    </a>

    <!-- Container con margine superiore aumentato per il tasto back -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-12">
        
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10">
            <div><h1 class="text-5xl font-black text-gray-900 uppercase italic text-blue-600">Altri Soggetti</h1></div>
            <div class="flex gap-4">
                <input type="text" id="searchInput" placeholder="Cerca..." class="input input-bordered shadow-xl w-full md:w-80" onkeyup="filterTable()" />
                <label for="modal-altri" onclick="preparaNuovo()" class="btn bg-blue-600 border-none text-white shadow-lg rounded-xl uppercase">Nuovo</label>
            </div>
        </div>
        <div class="card bg-white shadow-2xl rounded-3xl overflow-hidden">
            <table class="table w-full">
                <thead class="bg-gray-900 text-white uppercase text-xs"><tr><th class="py-6 px-8">Nome Soggetto</th><th>Email</th><th>Ente</th><th class="text-right px-8">Azione</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <input type="checkbox" id="modal-altri" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box rounded-3xl p-8 max-w-2xl">
            <h3 id="modal-title" class="font-black text-2xl uppercase mb-6 border-b-4 border-blue-600 pb-2 text-blue-600 italic">Dettaglio Soggetto</h3>
            <form id="altriForm" class="space-y-4">
                <input type="hidden" id="alt-id">
                <div class="form-control"><label class="label text-xs font-bold text-gray-400 uppercase">Nome Soggetto</label><input type="text" id="alt-nome" required class="input input-bordered font-bold uppercase"></div>
                <div class="form-control"><label class="label text-xs font-bold text-gray-400 uppercase">Email</label><input type="email" id="alt-mail" class="input input-bordered"></div>
                <div class="form-control">
                    <label class="label text-xs font-bold text-gray-400 uppercase">Ente Collegato</label>
                    <select id="alt-ente" required class="select select-bordered font-bold disabled:bg-gray-100 disabled:text-gray-500">
                        <!-- Popolato da JS -->
                    </select>
                </div>
                <!-- ID aggiunto per nascondere il messaggio visto che non si può più modificare -->
                <div id="alt-warning" class="p-3 bg-orange-50 border-l-4 border-orange-400 text-orange-800 text-[10px] font-bold uppercase italic hidden">Attenzione: se si modifica l'Ente, il collegamento con il vecchio verrà rimosso.</div>
                <div class="modal-action flex justify-between">
                    <button type="button" id="btn-delete" onclick="handleDelete()" class="btn btn-error btn-outline hidden uppercase font-bold text-xs">Elimina</button>
                    <div class="flex gap-2"><label for="modal-altri" class="btn btn-ghost uppercase text-xs font-bold font-black">Annulla</label><button type="button" onclick="handleSave()" class="btn bg-blue-600 border-none text-white font-bold uppercase px-8 text-xs shadow-lg">Salva</button></div>
                </div>
            </form>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/ui.js"></script>
    <script>
        let localDataCache = [];
        const validateEmail = (email) => !email || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

        async function init() {
            try {
                const [r1, r2] = await Promise.all([fetch('/api/all-altri-soggetti'), fetch('/api/associazioni')]);
                const soggetti = await r1.json();
                const enti = await r2.json();
                
                localDataCache = soggetti || [];
                document.getElementById('alt-ente').innerHTML = '<option value="" disabled selected>SCEGLI UN ENTE...</option>' + 
                                (enti || []).map(e => `<option value="${e.ID}">${e.SOGGETTO.toUpperCase()}</option>`).join('');
                renderTable(localDataCache);
            } catch(e){ console.error(e); }
        }

        function renderTable(data) {
            document.getElementById('tableBody').innerHTML = data.map(s => `
                <tr class="hover:bg-blue-50 cursor-pointer group" onclick="openEdit(${s.ID})">
                    <td class="font-black uppercase text-gray-800 py-6 px-8">${s.Nome}</td>
                    <td class="italic text-gray-500">${s.MAILALTRISOGGETTI || '-'}</td>
                    <td><span class="badge badge-ghost font-bold uppercase text-[10px]">${s.Ente_Nome || 'N.D.'}</span></td>
                    <td class="text-right px-8">
                        <button class="btn btn-xs btn-ghost text-blue-600 font-bold uppercase">Modifica <i data-lucide="edit-3" class="w-3 h-3 ml-1"></i></button>
                    </td>
                </tr>`).join('');
            if(window.lucide) lucide.createIcons();
        }

        function preparaNuovo() { 
            document.getElementById('altriForm').reset(); 
            document.getElementById('alt-id').value = ''; 
            document.getElementById('alt-ente').value = ''; 
            // Abilita la selezione dell'ente in creazione
            document.getElementById('alt-ente').disabled = false;
            // Nasconde l'avviso (inutile in creazione)
            document.getElementById('alt-warning').classList.add('hidden');
            document.getElementById('btn-delete').classList.add('hidden'); 
        }

        async function openEdit(id) {
            const s = localDataCache.find(x => x.ID == id);
            if(!s) return;
            document.getElementById('alt-id').value = s.ID;
            document.getElementById('alt-nome').value = s.Nome;
            document.getElementById('alt-mail').value = s.MAILALTRISOGGETTI || '';
            document.getElementById('alt-ente').value = s.ID_Associazione;
            
            // Disabilita la selezione dell'ente in modifica
            document.getElementById('alt-ente').disabled = true;
            // Nasconde l'avviso (poiché la modifica è bloccata)
            document.getElementById('alt-warning').classList.add('hidden');
            
            document.getElementById('btn-delete').classList.remove('hidden');
            document.getElementById('modal-altri').checked = true;
        }

        async function handleSave() {
            const id = document.getElementById('alt-id').value;
            const payload = { 
                Nome: document.getElementById('alt-nome').value.toUpperCase(), 
                MAILALTRISOGGETTI: document.getElementById('alt-mail').value, 
                ID_Associazione: parseInt(document.getElementById('alt-ente').value) 
            };
            if(!payload.Nome || !payload.ID_Associazione) return alert("Compilare Nome ed Ente.");
            if(!validateEmail(payload.MAILALTRISOGGETTI)) return alert("Email non valida.");
            if(!confirm("Salvare i dati?")) return;

            const url = id ? `/api/altri-soggetti/${id}` : '/api/altri-soggetti';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if(res.ok) { document.getElementById('modal-altri').checked = false; init(); }
            } catch(e) { console.error(e); }
        }

        async function handleDelete() {
            if(!confirm("Eliminare?")) return;
            try {
                const res = await fetch(`/api/altri-soggetti/${document.getElementById('alt-id').value}`, { method: 'DELETE' });
                if(res.ok) { document.getElementById('modal-altri').checked = false; init(); }
            } catch(e) { console.error(e); }
        }

        function filterTable() {
            const q = document.getElementById("searchInput").value.toUpperCase();
            const rows = document.getElementById("tableBody").getElementsByTagName("tr");
            for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(q) ? "" : "none";
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>